#!/usr/bin/env python

import sys
import time
import signal
import traceback

sys.path.insert(0, '../')

from omg.daemonize import Daemon
from omg.rpc import Listener
from omg.node.api import Api
from omg.node import register
from omg.log.api import setup

setup('node')
ctx = Daemon('/data/vms/bin', '/var/run/omg-node.pid')
node = register('tcp://127.0.0.1:5555')
l = Listener(node['uuid'], node['rpc_uri'])
ctx.signal(signal.SIGTERM, l.shut)
ctx.signal(signal.SIGINT, l.shut)

if not ctx.check_pid():
    print "Unable to lock pid file! Maybe daemon is already running?"
    sys.exit(1)

with ctx:
    try:
        ctx.update_pid()
        a = Api()
        l.add_class(a)
        l.start()
        while not l.is_shutdown():
            time.sleep(1)
    except Exception:
        debug(traceback.format_exc())
